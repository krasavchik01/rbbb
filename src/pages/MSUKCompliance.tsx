import { useState } from 'react';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Badge } from '@/components/ui/badge';
import { Checkbox } from '@/components/ui/checkbox';
import { 
  FileText, 
  CheckCircle, 
  AlertCircle, 
  Download, 
  Plus, 
  Trash2, 
  Eye, 
  BookOpen, 
  Zap,
  Upload
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';
import type { MSUKClient, MSUKFormData } from '@/types/msuk';
import { calculateRisk } from '@/utils/riskCalculation';
import { DEMO_CLIENTS } from '@/constants/msuk';
import { validateClientData, sanitizeString } from '@/utils/validation';
import { useMemo, useCallback } from 'react';

export default function MSUKCompliance() {
  const { toast } = useToast();
  
  const [clients, setClients] = useState<MSUKClient[]>([]);
  const [currentClient, setCurrentClient] = useState<MSUKClient | null>(null);
  const [showForm, setShowForm] = useState(false);
  const [showDemo, setShowDemo] = useState(false);
  const [showPreview, setShowPreview] = useState(false);
  const [previewData, setPreviewData] = useState<string | null>(null);
  const [previewTitle, setPreviewTitle] = useState('');

  const [formData, setFormData] = useState<MSUKFormData>({
    name: '',
    inn: '',
    country: 'RU',
    industry: '',
    address: '',
    publicCompany: false,
    litigation: false,
    conflictOfInterest: false,
    employees: '',
    employeesInAccounting: '',
    revenue: '',
    documentFlow: '',
    management: {
      director: '',
      directorPosition: '',
      directorContact: '',
      accountant: '',
      accountantContact: ''
    },
    teamMembers: []
  });
  
  const [showUploadDialog, setShowUploadDialog] = useState(false);
  const [isParsing, setIsParsing] = useState(false);

  // Мемоизируем расчет риска для текущего клиента для оптимизации производительности
  const currentRisk = useMemo(() => {
    return currentClient ? calculateRisk(currentClient) : null;
  }, [currentClient]);

  // Функция парсинга данных из загруженного документа
  const parseDocument = async (file: File): Promise<Partial<MSUKClient>> => {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const text = e.target?.result as string;
          const parsed: Partial<MSUKClient> = {};
          
          // Парсинг названия компании
          const nameMatch = text.match(/(?:ТОО|ООО|ПАО|ОАО|АО)\s*["«]?([^"»\n]+)["»]?/i);
          if (nameMatch) parsed.name = nameMatch[0].trim();
          
          // Парсинг ИНН
          const innMatch = text.match(/(?:ИНН|ИНН:)\s*(\d{10,12})/i);
          if (innMatch) parsed.inn = innMatch[1];
          
          // Парсинг адреса
          const addressMatch = text.match(/(?:Адрес|Адрес:)\s*([^\n]+)/i);
          if (addressMatch) parsed.address = addressMatch[1].trim();
          
          // Парсинг вида деятельности
          const industryMatch = text.match(/(?:Вид деятельности|Отрасль|Деятельность):\s*([^\n]+)/i);
          if (industryMatch) parsed.industry = industryMatch[1].trim();
          
          // Парсинг количества сотрудников
          const employeesMatch = text.match(/(?:Сотрудников|Численность|Количество сотрудников)[:\s]*(\d+)/i);
          if (employeesMatch) parsed.employees = employeesMatch[1];
          
          // Парсинг сотрудников в бухгалтерии
          const accEmployeesMatch = text.match(/(?:в бухгалтерии|бухгалтерии)[:\s]*(\d+)/i);
          if (accEmployeesMatch) parsed.employeesInAccounting = accEmployeesMatch[1];
          
          // Парсинг дохода
          const revenueMatch = text.match(/(?:Доход|Выручка|Годовой доход)[:\s]*([\d\s]+)\s*(?:млн|млрд|тенге|руб)/i);
          if (revenueMatch) parsed.revenue = revenueMatch[1].replace(/\s/g, '');
          
          // Парсинг документооборота
          const docFlowMatch = text.match(/(?:Документооборот|Регистров)[:\s]*(\d+)/i);
          if (docFlowMatch) parsed.documentFlow = docFlowMatch[1];
          
          // Парсинг страны
          if (text.match(/Казахстан|KZ|KZ-/i)) parsed.country = 'KZ';
          else if (text.match(/Россия|RU|RU-/i)) parsed.country = 'RU';
          
          // Парсинг флагов
          parsed.publicCompany = /публичн|ПЗО|публичное/i.test(text);
          parsed.litigation = /судебн|разбирательств|иск/i.test(text);
          parsed.conflictOfInterest = /конфликт|интересов/i.test(text);
          
          // Парсинг руководства
          const directorMatch = text.match(/(?:Директор|Генеральный директор|Руководитель)[:\s]*([А-ЯЁ][а-яё]+\s+[А-ЯЁ][а-яё]+(?:\s+[А-ЯЁ][а-яё]+)?)/i);
          if (directorMatch) {
            parsed.management = {
              director: directorMatch[1],
              directorPosition: 'Генеральный директор',
              directorContact: '',
              accountant: '',
              accountantContact: ''
            };
          }
          
          resolve(parsed);
        } catch (error) {
          reject(error);
        }
      };
      
      reader.onerror = reject;
      reader.readAsText(file);
    });
  };

  const generateDocuments = (client: Partial<MSUKClient>) => {
    const risk = calculateRisk(client);
    const date = new Date().toLocaleDateString('ru-RU');

    const kycForm = `
═══════════════════════════════════════════════════════════
АНКЕТА КЛИЕНТА ПО МСУК-1
═══════════════════════════════════════════════════════════
Дата заполнения: ${date}

I. ОБЩАЯ ИНФОРМАЦИЯ
─────────────────────────────────────────────────────────
Наименование: ${client.name}
ИНН: ${client.inn}
Страна: ${client.country}
Вид деятельности: ${client.industry}
Количество сотрудников: ${client.employees}
Годовой доход: ${client.revenue} млн тенге

II. ФАКТОРЫ РИСКА КАЧЕСТВА (МСУК-1)
─────────────────────────────────────────────────────────
✓ Публичная компания (ПЗО): ${client.publicCompany ? 'ДА' : 'НЕТ'}
✓ Судебные разбирательства: ${client.litigation ? 'ДА' : 'НЕТ'}
✓ Конфликт интересов: ${client.conflictOfInterest ? 'ДА' : 'НЕТ'}

III. ОЦЕНКА РИСКОВ
─────────────────────────────────────────────────────────
Общий уровень риска: ${risk.riskText}
Индекс риска: ${risk.riskLevel}/5

Выявленные факторы:
${risk.factors.map(f => f).join('\n')}

IV. СПЕЦИАЛЬНЫЕ ТРЕБОВАНИЯ
─────────────────────────────────────────────────────────
EQR требуется: ${risk.eqrRequired ? 'ДА - Независимый проверяющий' : 'НЕТ'}
Ротация партнёра: ${client.publicCompany ? 'Каждые 7 лет (для ПЗО)' : 'Каждые 10 лет'}
Мониторинг: Ежегодно

V. ВЫВОД
─────────────────────────────────────────────────────────
Статус: ${risk.riskText === 'ВЫСОКИЙ' ? '⚠️ ТРЕБУЕТСЯ УСИЛЕННАЯ ПРОВЕРКА' : '✓ ОДОБРЕНО'}

Дата: ${date}
Подготовил: _________________________
Проверил: _________________________
    `.trim();

    const independenceForm = `
═══════════════════════════════════════════════════════════
ЗАЯВЛЕНИЕ О НЕЗАВИСИМОСТИ
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Дата: ${date}

ПОДТВЕРЖДЕНИЕ НЕЗАВИСИМОСТИ:
─────────────────────────────────────────────────────────
✓ Не является учредителем клиента
✓ Отсутствует финансовая заинтересованность
✓ Нет тесных деловых отношений
✓ Не предоставляли займы или поручительства
✓ Отсутствуют семейные или личные отношения
✓ Соблюдены требования по независимости
✓ Нет конфликтов интересов
✓ Полностью рассчиталось с клиентом

ВЫВОД:
─────────────────────────────────────────────────────────
Подтверждаем НЕЗАВИСИМОСТЬ аудиторской организации.

Дата: ${date}
Подпись руководителя: _________________________
    `.trim();

    const complianceChecklist = `
═══════════════════════════════════════════════════════════
ЧЕКЛИСТ СООТВЕТСТВИЯ МСУК-1
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Проверено: ${date}

8 КОМПОНЕНТОВ МСУК-1:
─────────────────────────────────────────────────────────
☑ 1. Процесс оценки рисков: ВЫПОЛНЕНО (${risk.riskText})
☑ 2. Руководство и управление: ТРЕБУЕТСЯ
☑ 3. Этические требования: ВЫПОЛНЕНО
☑ 4. Принятие клиента: ВЫПОЛНЕНО
☑ 5. Выполнение заданий: ТРЕБУЕТСЯ
☑ 6. Ресурсы: ГОТОВО
☑ 7. Информационные системы: ТРЕБУЕТСЯ
☑ 8. Мониторинг: ТРЕБУЕТСЯ

КРИТИЧЕСКИЕ ТРЕБОВАНИЯ:
─────────────────────────────────────────────────────────
✓ KYC/Due Diligence: ВЫПОЛНЕНО
✓ Проверка независимости: ВЫПОЛНЕНО
✓ Скрининг санкций: ТРЕБУЕТСЯ
${risk.eqrRequired ? '✓ EQR ТРЕБУЕТСЯ - ОБЯЗАТЕЛЕН' : ''}

РЕКОМЕНДАЦИЯ:
─────────────────────────────────────────────────────────
${risk.riskText === 'ВЫСОКИЙ' ? '🔴 ВЫСОКИЙ РИСК - УСИЛЕННАЯ ПРОВЕРКА' : '✓ К ПРИНЯТИЮ'}

Дата проверки: ${date}
Проверил: _________________________
Утвердил: _________________________
    `.trim();

    const eqrForm = risk.eqrRequired ? `
═══════════════════════════════════════════════════════════
ФОРМА НАЗНАЧЕНИЯ EQR
(Engagement Quality Reviewer - Проверяющий качества)
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Дата назначения: ${date}
Статус: 🔴 ОБЯЗАТЕЛЬНОЕ НАЗНАЧЕНИЕ

ОБОСНОВАНИЕ НАЗНАЧЕНИЯ EQR (МСУК-2):
─────────────────────────────────────────────────────────
${risk.factors.map(f => f).join('\n')}

НОРМАТИВНАЯ БАЗА:
─────────────────────────────────────────────────────────
• МСУК-1 пункт 34(f) - Назначение EQR при высоких рисках
• МСУК-2 пункты 17-19 - Процедуры работы EQR
• МСА 220 - Управление качеством при аудите

ТРЕБОВАНИЯ К EQR:
─────────────────────────────────────────────────────────
☑ НЕ входит в состав аудиторской группы
☑ Обладает необходимой компетентностью
☑ Соблюдает требования независимости
☑ Cooling-off период: 2 года (для бывших руководителей)
☑ Все выводы письменно

ОБЯЗАННОСТИ EQR:
─────────────────────────────────────────────────────────
1. Запросить и изучить всю существенную информацию
2. Обсудить существенные вопросы с руководителем
3. Проверить документацию по ключевым вопросам
4. Оценить обоснованность суждений
5. Убедиться в наличии профессионального скептицизма
6. Оценить соблюдение этических требований
7. Проверить надлежащесть консультаций
8. Подписать "Stand-back" подтверждение

Дата: ${date}
Ответственный: _________________________
Подпись: _________________________
    `.trim() : '';

    // Дополнительные документы
    const clientAcceptanceForm = `
═══════════════════════════════════════════════════════════
АНКЕТА ПРИНЯТИЯ КЛИЕНТА
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Дата: ${date}

I. ОЦЕНКА РИСКОВ
─────────────────────────────────────────────────────────
Общий уровень риска: ${risk.riskText}
Индекс риска: ${risk.riskLevel}/5

II. ПРОВЕРКА ДОБРОСОВЕСТНОСТИ РУКОВОДСТВА
─────────────────────────────────────────────────────────
☑ Проверка репутации руководства: ВЫПОЛНЕНО
☑ Проверка судебных разбирательств: ${client.litigation ? 'ОБНАРУЖЕНО' : 'НЕ ОБНАРУЖЕНО'}
☑ Проверка конфликтов интересов: ${client.conflictOfInterest ? 'ОБНАРУЖЕНО' : 'НЕ ОБНАРУЖЕНО'}

III. КОМПЕТЕНТНОСТЬ АУДИТОРОВ
─────────────────────────────────────────────────────────
☑ Наличие необходимой квалификации: ТРЕБУЕТСЯ
☑ Опыт работы в отрасли: ТРЕБУЕТСЯ
☑ Достаточность ресурсов: ТРЕБУЕТСЯ

IV. ВЫВОД
─────────────────────────────────────────────────────────
Статус: ${risk.riskText === 'ВЫСОКИЙ' ? '⚠️ ТРЕБУЕТСЯ ДОПОЛНИТЕЛЬНАЯ ПРОВЕРКА' : '✓ К ПРИНЯТИЮ'}

Дата: ${date}
Подготовил: _________________________
Утвердил: _________________________
    `.trim();

    const itSecurityChecklist = `
═══════════════════════════════════════════════════════════
ИТ БЕЗОПАСНОСТЬ - ЧЕКЛИСТ
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Дата проверки: ${date}

I. УПРАВЛЕНИЕ ДОСТУПОМ
─────────────────────────────────────────────────────────
☑ Active Directory настроен: ТРЕБУЕТСЯ
☑ Разграничение прав доступа: ТРЕБУЕТСЯ
☑ Регулярная смена паролей: ТРЕБУЕТСЯ
☑ Двухфакторная аутентификация: ТРЕБУЕТСЯ

II. РЕЗЕРВНОЕ КОПИРОВАНИЕ
─────────────────────────────────────────────────────────
☑ Автоматическое резервное копирование: ТРЕБУЕТСЯ
☑ Периодичность копирования: Ежедневно
☑ Хранение копий: Не менее 30 дней
☑ Тестирование восстановления: Ежеквартально

III. ЛОГИРОВАНИЕ ИЗМЕНЕНИЙ
─────────────────────────────────────────────────────────
☑ Логирование всех изменений: ТРЕБУЕТСЯ
☑ Хранение логов: Не менее 1 года
☑ Мониторинг логов: Ежедневно
☑ Анализ подозрительной активности: ТРЕБУЕТСЯ

IV. ФИЗИЧЕСКИЙ ДОСТУП
─────────────────────────────────────────────────────────
☑ Контроль доступа в серверные: ТРЕБУЕТСЯ
☑ Видеонаблюдение: ТРЕБУЕТСЯ
☑ Журнал посещений: ТРЕБУЕТСЯ
☑ Ограничение доступа: ТРЕБУЕТСЯ

Дата: ${date}
Проверил: _________________________
    `.trim();

    const engagementLetter = `
═══════════════════════════════════════════════════════════
ПИСЬМО-СОГЛАШЕНИЕ (МСА 210)
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Дата: ${date}

I. УСЛОВИЯ АУДИТОРСКОГО ЗАДАНИЯ
─────────────────────────────────────────────────────────
Цель: Проведение аудита финансовой отчетности за ${new Date().getFullYear()} год

Объем работ:
• Аудит финансовой отчетности
• Проверка соответствия МСФО/НСФО
• Проверка внутреннего контроля
• Формирование аудиторского заключения

II. ОТВЕТСТВЕННОСТЬ СТОРОН
─────────────────────────────────────────────────────────
Клиент обязуется:
• Предоставить всю необходимую документацию
• Обеспечить доступ к информационным системам
• Предоставить разъяснения по запросам аудиторов

Аудиторская организация обязуется:
• Провести аудит в соответствии с МСА
• Соблюдать конфиденциальность
• Предоставить аудиторское заключение в срок

III. СТОИМОСТЬ И СРОКИ
─────────────────────────────────────────────────────────
Стоимость: ___________________ тенге
Срок выполнения: ___________________
Форма оплаты: ___________________

IV. ПОДПИСИ
─────────────────────────────────────────────────────────
Клиент: _________________________ (подпись)
Аудиторская организация: _________________________ (подпись)

Дата: ${date}
    `.trim();

    const teamIndependenceStatements = (client.teamMembers || []).map(member => `
═══════════════════════════════════════════════════════════
ЗАЯВЛЕНИЕ О НЕЗАВИСИМОСТИ ЧЛЕНА КОМАНДЫ
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Член команды: ${member.name}
Должность: ${member.position}
Роль: ${member.role}
Дата: ${date}

ПОДТВЕРЖДЕНИЕ НЕЗАВИСИМОСТИ:
─────────────────────────────────────────────────────────
Я, ${member.name}, подтверждаю, что:
✓ Не имею финансовой заинтересованности в клиенте
✓ Не состою в родственных отношениях с руководством
✓ Не предоставлял займы или поручительства
✓ Не получал подарки или услуги от клиента
✓ Соблюдаю требования независимости по МСА

Подпись: _________________________
Дата: ${date}
    `.trim()).join('\n\n') || 'Члены команды не назначены';

    const organizationIndependenceStatement = `
═══════════════════════════════════════════════════════════
ЗАЯВЛЕНИЕ ОРГАНИЗАЦИИ О НЕЗАВИСИМОСТИ
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Аудиторская организация: _________________________
Дата: ${date}

ПОДТВЕРЖДЕНИЕ НЕЗАВИСИМОСТИ ОРГАНИЗАЦИИ:
─────────────────────────────────────────────────────────
Аудиторская организация подтверждает, что:
✓ Не является учредителем или акционером клиента
✓ Не предоставляла займы или поручительства
✓ Не имеет тесных деловых отношений
✓ Соблюдены все требования независимости по МСА
✓ Все члены команды подтвердили свою независимость

Руководитель аудиторской организации: _________________________
Подпись: _________________________
Дата: ${date}
    `.trim();

    const communicationProtocol = `
═══════════════════════════════════════════════════════════
ПРОТОКОЛ ОБЩЕНИЯ С АУДИТОРОМ
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Дата: ${date}

I. КОНТАКТНЫЕ ЛИЦА
─────────────────────────────────────────────────────────
От клиента:
Руководитель: ${client.management?.director || '___________________'}
Контакт: ${client.management?.directorContact || '___________________'}

Главный бухгалтер: ${client.management?.accountant || '___________________'}
Контакт: ${client.management?.accountantContact || '___________________'}

От аудиторской организации:
Руководитель задания: ___________________
Контакт: ___________________

II. ПРОЦЕДУРЫ ОБЩЕНИЯ
─────────────────────────────────────────────────────────
• Регулярные встречи: Еженедельно
• Отчетность: Ежемесячно
• Срочные вопросы: В течение 24 часов
• Форма общения: Email, телефон, личные встречи

III. КОНФИДЕНЦИАЛЬНОСТЬ
─────────────────────────────────────────────────────────
Все обсуждения и документы являются конфиденциальными.

Дата: ${date}
    `.trim();

    const auditPlan = `
═══════════════════════════════════════════════════════════
ПЛАН ПРОВЕДЕНИЯ АУДИТА
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Период: ${new Date().getFullYear()} год
Дата составления: ${date}

I. ЭТАПЫ АУДИТА
─────────────────────────────────────────────────────────
1. Планирование аудита: ___________________
2. Оценка рисков: ___________________
3. Тестирование средств контроля: ___________________
4. Субстантивные процедуры: ___________________
5. Завершение аудита: ___________________
6. Формирование заключения: ___________________

II. РЕСУРСЫ
─────────────────────────────────────────────────────────
Руководитель задания: ___________________
Члены команды: ${(client.teamMembers || []).map(m => m.name).join(', ') || 'Не назначены'}
EQR: ${risk.eqrRequired ? 'ТРЕБУЕТСЯ' : 'Не требуется'}

III. ОСОБЫЕ ВНИМАНИЯ
─────────────────────────────────────────────────────────
${risk.factors.length > 0 ? risk.factors.map(f => `• ${f}`).join('\n') : '• Стандартные процедуры'}

Дата: ${date}
Составил: _________________________
    `.trim();

    // Дополнительные документы (10-25)
    const workingPapers = `
═══════════════════════════════════════════════════════════
РАБОЧИЕ БУМАГИ АУДИТОРА - ШАБЛОН
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Период: ${new Date().getFullYear()} год
Индекс рабочей бумаги: РБ-___

ОБЛАСТЬ АУДИТА: _____________________
ДАТА ВЫПОЛНЕНИЯ: ${date}
ВЫПОЛНИЛ: _____________________
ПРОВЕРИЛ: _____________________

ЦЕЛЬ ПРОЦЕДУРЫ
─────────────────────────────────────────────────────────
_________________________________________________________________

МЕТОДОЛОГИЯ И ПОДХОД
─────────────────────────────────────────────────────────
_________________________________________________________________

ВЫБОРКА И ТЕСТИРОВАНИЕ
─────────────────────────────────────────────────────────
Размер совокупности: _____ единиц
Размер выборки: _____ единиц
Методология выборки: Случайная / Систематическая / Целевая

ВЫПОЛНЕННЫЕ ПРОЦЕДУРЫ
─────────────────────────────────────────────────────────
1. _________________________________________________________________
2. _________________________________________________________________
3. _________________________________________________________________

РЕЗУЛЬТАТЫ ТЕСТИРОВАНИЯ
─────────────────────────────────────────────────────────
Количество ошибок: _____
Сумма выявленных ошибок: _____
Характер ошибок: _____________________

ОЦЕНКА РЕЗУЛЬТАТОВ
─────────────────────────────────────────────────────────
Утверждение для тестирования: _____________________
Выявлены ошибки: Да / Нет
Значимость ошибок: Существенная / Значимая / Незначительная

ЗАКЛЮЧЕНИЕ И ВЫВОДЫ
─────────────────────────────────────────────────────────
_________________________________________________________________

ССЫЛКИ НА ДРУГИЕ РБ
─────────────────────────────────────────────────────────
_________________________________________________________________

Выполнил: _____________________ (подпись)
Проверил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const riskMatrix = `
═══════════════════════════════════════════════════════════
МАТРИЦА РИСКОВ АУДИТА
═══════════════════════════════════════════════════════════
Клиент: ${client.name}
Период аудита: ${new Date().getFullYear()} год
Дата подготовки: ${date}

ПРОЦЕСС ОЦЕНКИ РИСКОВ
─────────────────────────────────────────────────────────
№ | РИСК | ВЕРОЯТНОСТЬ | ВЛИЯНИЕ | УРОВЕНЬ | ОТВЕТНЫЕ ПРОЦЕДУРЫ
─────────────────────────────────────────────────────────────
1. | Завышение доходов | Высокая | Высокое | Критический | Детальные тесты счетов-фактур
2. | Недопроводимые расходы | Средняя | Высокое | Средний | Выборочная проверка счетов
3. | Переоценка запасов | Средняя | Среднее | Средний | Наблюдение инвентаризации
4. | Неправильная амортизация | Низкая | Среднее | Низкий | Пересчет амортизации
5. | Несанкционированное списание | Низкая | Высокое | Средний | Сверка выписок банка

ШКАЛА ОЦЕНКИ
─────────────────────────────────────────────────────────
ВЕРОЯТНОСТЬ ВОЗНИКНОВЕНИЯ:
1 (Низкая) = Менее 25%
2 (Средняя) = 25-75%
3 (Высокая) = Более 75%

ВЛИЯНИЕ НА ФИНАНСОВУЮ ОТЧЕТНОСТЬ:
1 (Низкое) = Менее 5% существенности
2 (Среднее) = 5-25% существенности
3 (Высокое) = Более 25% существенности

УРОВЕНЬ РИСКА (Вероятность × Влияние):
1-2 = НИЗКИЙ РИСК → Аналитические процедуры
3-4 = СРЕДНИЙ РИСК → Выборочное тестирование
6-9 = КРИТИЧЕСКИЙ РИСК → Детальные тесты

ОТВЕТНЫЕ ПРОЦЕДУРЫ
─────────────────────────────────────────────────────────
Критические риски:
→ Детальные тесты всех операций или больших выборок
→ Привлечение специалистов при необходимости
→ Повышенное внимание при завершении аудита

Средние риски:
→ Сочетание аналитических процедур и тестирования
→ Выборочное тестирование (обычно 25-50% совокупности)

Низкие риски:
→ Аналитические процедуры
→ Выборочное тестирование (обычно 10-25% совокупности)

ПЕРЕСМОТР ОЦЕНКИ РИСКОВ
─────────────────────────────────────────────────────────
Пересмотрена во время: _____________________
Причины пересмотра: _____________________

Подготовил: _____________________ (подпись)
Проверил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const taxDeclaration = `
═══════════════════════════════════════════════════════════
НАЛОГОВАЯ ДЕКЛАРАЦИЯ И РАСЧЕТЫ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата подготовки: ${date}

I. НАЛОГ НА ДОБАВЛЕННУЮ СТОИМОСТЬ (НДС)
─────────────────────────────────────────────────────────
Облагаемые продажи: ___________________
НДС выставленный (20%): ___________________
Входящий НДС: ___________________
НДС к возмещению: ___________________
НДС к уплате: ___________________

I квартал: ___________________
II квартал: ___________________
III квартал: ___________________
IV квартал: ___________________

II. НАЛОГ НА ПРИБЫЛЬ ПРЕДПРИЯТИЯ
─────────────────────────────────────────────────────────
Валовой доход: ${client.revenue}
Валовые расходы: ___________________
Прибыль от операционной деятельности: ___________________
Прибыль до налогообложения: ___________________
Налог на прибыль (10%): ___________________
Чистая прибыль: ___________________

III. СОЦИАЛЬНЫЕ НАЛОГИ И ВЗНОСЫ
─────────────────────────────────────────────────────────
Фонд оплаты труда: ___________________
Социальный налог на зарплату (9.5%): ___________________
Обязательные пенсионные взносы (10%): ___________________
Добровольные пенсионные взносы: ___________________
Медицинское страхование: ___________________
Итого социальные взносы: ___________________

IV. СПЕЦИАЛЬНЫЕ НАЛОГИ
─────────────────────────────────────────────────────────
Акцизы: ___________________
Таможенные пошлины: ___________________
Земельный налог: ___________________
Налог на имущество: ___________________
Транспортный налог: ___________________

V. НАЛОГОВЫЕ ОТСРОЧКИ И ЛЬГОТЫ
─────────────────────────────────────────────────────────
Применяемые льготы: _____________________
Отсроченные налоги: ___________________
Причины отсрочек: _____________________

VI. НАЛОГОВЫЕ ПРОВЕРКИ
─────────────────────────────────────────────────────────
Проведены проверки в ${new Date().getFullYear()} году: Да / Нет
Тип проверки: _____________________
Результаты: _____________________
Выявленные нарушения: _____________________
Уплаченные штрафы: ___________________

VII. НАЛОГОВЫЕ РИСКИ И РАЗНОГЛАСИЯ
─────────────────────────────────────────────────────────
Значимые разногласия с налоговыми органами: _____________________
Судебные разбирательства: Да / Нет
Состояние разбирательств: _____________________

ИТОГОВЫЙ РАСЧЕТ НАЛОГОВЫХ ОБЯЗАТЕЛЬСТВ
─────────────────────────────────────────────────────────
НДС: ___________________
Налог на прибыль: ___________________
Социальные взносы: ___________________
Прочие налоги: ___________________
─────────────────────────────────────────────────────────
ИТОГО К УПЛАТЕ: ___________________

Подготовил: _____________________ (подпись)
Главный бухгалтер: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const payrollStatement = `
═══════════════════════════════════════════════════════════
ТРУДОВЫЕ ОТНОШЕНИЯ И ЗАРПЛАТНАЯ ВЕДОМОСТЬ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата подготовки: ${date}

I. ОБЩАЯ ИНФОРМАЦИЯ О ПЕРСОНАЛЕ
─────────────────────────────────────────────────────────
Общая численность: ${client.employees} чел
Численность в бухгалтерии: ${client.employeesInAccounting || '___'} чел
Средняя заработная плата: ___________________

II. СТРУКТУРА ЗАРАБОТНОЙ ПЛАТЫ
─────────────────────────────────────────────────────────
Фонд оплаты труда за год: ___________________
Окладная часть: ___________________
Премии и надбавки: ___________________
Командировочные: ___________________
Прочие выплаты: ___________________

III. НАЛОГИ И ВЫЧЕТЫ
─────────────────────────────────────────────────────────
Индивидуальный налог граждан (10%): ___________________
Обязательные пенсионные взносы (10%): ___________________
Добровольные пенсионные взносы: ___________________
Медицинское страхование: ___________________
Итого налоги и вычеты: ___________________

IV. ЕЖЕМЕСЯЧНЫЕ ВЕДОМОСТИ
─────────────────────────────────────────────────────────
Январь: ___________________
Февраль: ___________________
Март: ___________________
Апрель: ___________________
Май: ___________________
Июнь: ___________________
Июль: ___________________
Август: ___________________
Сентябрь: ___________________
Октябрь: ___________________
Ноябрь: ___________________
Декабрь: ___________________

V. ОТПУСКА И НАДБАВКИ
─────────────────────────────────────────────────────────
Ежегодные отпуска: _____ дней
Отпуск по уходу за ребенком: _____ дней
Больничные дни: _____ дней
Надбавка за выслугу лет: ___________________
Надбавка за квалификацию: ___________________

VI. ТРУДОВЫЕ КОНТРАКТЫ И СОГЛАШЕНИЯ
─────────────────────────────────────────────────────────
Все ли сотрудники имеют письменные контракты: Да / Нет
Коллективный договор заключен: Да / Нет
Дата заключения: _____________________
Наличие правил внутреннего распорядка: Да / Нет

VII. ПРОВЕРКИ ТРУДОВОЙ ИНСПЕКЦИИ
─────────────────────────────────────────────────────────
Проводились проверки в ${new Date().getFullYear()} году: Да / Нет
Результаты: _____________________
Выявленные нарушения: _____________________

Подготовил: _____________________ (подпись)
Главный бухгалтер: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const fixedAssets = `
═══════════════════════════════════════════════════════════
ОСНОВНЫЕ СРЕДСТВА И АМОРТИЗАЦИЯ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата: ${date}

I. РЕЕСТР ОСНОВНЫХ СРЕДСТВ
─────────────────────────────────────────────────────────
№ | НАИМЕНОВАНИЕ | ПЕРВОНАЧАЛЬНАЯ | НАКОПЛЕННАЯ | ОСТАТОЧНАЯ
| | СТОИМОСТЬ | АМОРТИЗАЦИЯ | СТОИМОСТЬ
──────────────────────────────────────────────────────────────
1. | Здания и сооружения | _____ | _____ | _____
2. | Машины и оборудование | _____ | _____ | _____
3. | Компьютеры и ПО | _____ | _____ | _____
4. | Мебель и оборудование | _____ | _____ | _____
5. | Транспортные средства | _____ | _____ | _____
6. | Прочие ОС | _____ | _____ | _____
──────────────────────────────────────────────────────────────
ИТОГО: | _____ | _____ | _____

II. ДВИЖЕНИЕ ОСНОВНЫХ СРЕДСТВ ЗА ГОД
─────────────────────────────────────────────────────────
Остаток на начало года: ___________________
Поступление ОС: ___________________
Выбытие ОС: ___________________
Переоценка ОС: ___________________
Остаток на конец года: ___________________

III. АМОРТИЗАЦИЯ
─────────────────────────────────────────────────────────
Ставка амортизации здания: _____ %
Ставка амортизации оборудования: _____ %
Ставка амортизации компьютеров: _____ %
Ставка амортизации мебели: _____ %
Ставка амортизации транспорта: _____ %
Начисленная амортизация в ${new Date().getFullYear()} году: ___________________
Накопленная амортизация: ___________________

IV. ВЫБЫТИЕ ОСНОВНЫХ СРЕДСТВ
─────────────────────────────────────────────────────────
Кол-во выбывших ОС: _____
Сумма выбытия: ___________________
Прибыль/убыток от выбытия: ___________________
Документация по выбытию: Да / Нет

V. ПЕРЕОЦЕНКА ОСНОВНЫХ СРЕДСТВ
─────────────────────────────────────────────────────────
Проводилась переоценка: Да / Нет
Дата последней переоценки: _____________________
Метод переоценки: _____________________
Результат переоценки: ___________________

VI. АРЕНДА ОСНОВНЫХ СРЕДСТВ
─────────────────────────────────────────────────────────
Операционная аренда: ___________________
Финансовая аренда: ___________________
Договоры аренды имущества: Да / Нет

VII. ОБСЛУЖИВАНИЕ И РЕМОНТ
─────────────────────────────────────────────────────────
Расходы на текущий ремонт: ___________________
Расходы на капитальный ремонт: ___________________
Плановые расходы на ремонт: ___________________

VIII. СТРАХОВАНИЕ ОСНОВНЫХ СРЕДСТВ
─────────────────────────────────────────────────────────
Застрахованы ОС: Да / Нет
Сумма страховки: ___________________
Действующие полисы: Да / Нет

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const inventory = `
═══════════════════════════════════════════════════════════
ЗАПАСЫ И ТОВАРНО-МАТЕРИАЛЬНЫЕ ЦЕННОСТИ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата: ${date}

I. СТРУКТУРА ЗАПАСОВ
─────────────────────────────────────────────────────────
Категория | Кол-во единиц | Стоимость | % от итога
──────────────────────────────────────────────────
Сырье и материалы | _____ | _____ | _____%
Готовая продукция | _____ | _____ | _____%
Товары в пути | _____ | _____ | _____%
Прочие запасы | _____ | _____ | _____%
────────────────────────────────────────────────────
ИТОГО: | | _____ | 100%

II. МЕТОДЫ ОЦЕНКИ ЗАПАСОВ
─────────────────────────────────────────────────────────
ФИФО: Да / Нет
ЛИФО: Да / Нет
Средневзвешенная стоимость: Да / Нет
Нормативная стоимость: Да / Нет

III. ДВИЖЕНИЕ ЗАПАСОВ ЗА ГОД
─────────────────────────────────────────────────────────
Остаток на 01.01.${new Date().getFullYear()}: ___________________
Поступления за год: ___________________
Выбытие за год: ___________________
Остаток на 31.12.${new Date().getFullYear()}: ___________________

IV. ИНВЕНТАРИЗАЦИЯ ЗАПАСОВ
─────────────────────────────────────────────────────────
Дата проведения инвентаризации: _____________________
Выявленные расхождения: ___________________
Причины расхождений: _____________________
Провели ли аудитор наблюдение: Да / Нет

V. УСТАРЕВШИЕ И МЕДЛЕННОДВИЖУЩИЕСЯ ЗАПАСЫ
─────────────────────────────────────────────────────────
Выявлены ли устаревшие запасы: Да / Нет
Кол-во устаревших: _____ единиц
Стоимость устаревших: ___________________
Резерв на снижение стоимости: ___________________

VI. ЗАЛОГИРОВАННЫЕ ЗАПАСЫ
─────────────────────────────────────────────────────────
Запасы под залогом: Да / Нет
Сумма залога: ___________________
Договор залога: Да / Нет

VII. ТОВАРЫ В ПУТИ
─────────────────────────────────────────────────────────
Кол-во товаров в пути: _____
Стоимость: ___________________
Условия доставки: _____________________
Дата ожидаемого прибытия: _____________________

VIII. СЕБЕСТОИМОСТЬ ГОТОВОЙ ПРОДУКЦИИ
─────────────────────────────────────────────────────────
Прямые материалы: ___________________
Прямой труд: ___________________
Производственные накладные: ___________________
─────────────────────────────────────────────────────────
Итоговая себестоимость: ___________________

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const financialObligations = `
═══════════════════════════════════════════════════════════
ФИНАНСОВЫЕ ОБЯЗАТЕЛЬСТВА И КРЕДИТЫ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата: ${date}

I. КРЕДИТЫ И ЗАЙМЫ
─────────────────────────────────────────────────────────
№ | КРЕДИТОР | СУММА | СТАВКА | СРОК ПОГАШЕНИЯ | ОСТАТОК
────────────────────────────────────────────────────────
1. | БанкКазахстана | _____ | _____% | _____ | _____
2. | Альтбанк | _____ | _____% | _____ | _____
3. | КазКомерцБанк | _____ | _____% | _____ | _____
────────────────────────────────────────────────────────────
ИТОГО: | | | | | _____

II. ПРОЦЕНТНЫЕ РАСХОДЫ
─────────────────────────────────────────────────────────
Начисленные проценты: ___________________
Уплаченные проценты: ___________________
Капитализированные проценты: ___________________

III. УСЛОВИЯ КРЕДИТОВАНИЯ
─────────────────────────────────────────────────────────
Наличие ковенантов: Да / Нет
Нарушения ковенантов: Да / Нет
Залоги: Да / Нет
Гарантии: Да / Нет

IV. ОПЕРАЦИОННАЯ АРЕНДА
─────────────────────────────────────────────────────────
Годовая арендная плата: ___________________
Минимальные будущие платежи:
1 год: ___________________
2 года: ___________________
3+ года: ___________________

V. ЛИЗИНГ
─────────────────────────────────────────────────────────
Финансовый лизинг: Да / Нет
Стоимость активов под лизингом: ___________________
Будущие платежи по лизингу: ___________________

VI. ВЕКСЕЛЯ К ОПЛАТЕ
─────────────────────────────────────────────────────────
Количество векселей: _____
Сумма: ___________________
Дата погашения: _____________________

VII. КРЕДИТОРСКАЯ ЗАДОЛЖЕННОСТЬ
─────────────────────────────────────────────────────────
Задолженность перед поставщиками: ___________________
Задолженность перед бюджетом: ___________________
Задолженность перед персоналом: ___________________
Прочая кредиторская задолженность: ___________________
─────────────────────────────────────────────────────────
ИТОГО ОБЯЗАТЕЛЬСТВА: ___________________

VIII. ДЕФОЛТЫ И НАРУШЕНИЯ
─────────────────────────────────────────────────────────
Просроченные платежи: Да / Нет
Сумма просрочки: ___________________
Штрафные санкции: ___________________

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const relatedParties = `
═══════════════════════════════════════════════════════════
СВЯЗАННЫЕ СТОРОНЫ И ОПЕРАЦИИ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата: ${date}

I. ИДЕНТИФИКАЦИЯ СВЯЗАННЫХ СТОРОН
─────────────────────────────────────────────────────────
Головная компания: _____________________
Дочерние компании: _____________________
Ассоциированные компании: _____________________
Совместные предприятия: _____________________
Ключевые руководители: ${client.management?.director || '___________________'}, ${client.management?.accountant || '___________________'}
Основные акционеры: _____________________

II. ОБЪЕМ ОПЕРАЦИЙ СО СВЯЗАННЫМИ СТОРОНАМИ
─────────────────────────────────────────────────────────
Сторона | Тип операции | Сумма | Условия | Статус
─────────────────────────────────────────────────
Головная компания | Продажа | _____ | Рыночные | _____
Дочерняя компания | Покупка | _____ | Рыночные | _____
Ассоциированная | Аренда | _____ | Договор | _____
Ключевой персонал | Зарплата | _____ | Трудовой | _____

III. ЗАДОЛЖЕННОСТЬ ПО ОПЕРАЦИЯМ СО СВЯЗАННЫМИ СТОРОНАМИ
─────────────────────────────────────────────────────────
Дебиторская задолженность: ___________________
Кредиторская задолженность: ___________________
Взаимные расчеты: ___________________

IV. ТРАНСФЕРТНОЕ ЦЕНООБРАЗОВАНИЕ
─────────────────────────────────────────────────────────
Используется ли трансфертное ценообразование: Да / Нет
Принцип ценообразования: _____________________
Документация по трансфертному ценообразованию: Да / Нет
Соответствие принципу "вытянутой руки": Да / Нет

V. РАСКРЫТИЕ ИНФОРМАЦИИ
─────────────────────────────────────────────────────────
Раскрыты ли все операции в отчетности: Да / Нет
Полнота раскрытия: _____________________

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const internalControl = `
═══════════════════════════════════════════════════════════
ОЦЕНКА СИСТЕМЫ ВНУТРЕННЕГО КОНТРОЛЯ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата оценки: ${date}

I. КОНТРОЛЬНАЯ СРЕДА
─────────────────────────────────────────────────────────
☐ Честность руководства подтверждена
☐ Компетентность персонала достаточна
☐ Структура управления четко определена
☐ Разделение функций обеспечено
☐ Система авторизации функционирует
☐ Система документирования адекватна

II. ОЦЕНКА РИСКОВ
─────────────────────────────────────────────────────────
☐ Идентифицированы ключевые риски
☐ Оценены вероятность и воздействие
☐ Разработаны ответные процедуры
☐ Риски регулярно мониторятся

III. ИНФОРМАЦИОННАЯ СИСТЕМА И КОММУНИКАЦИЯ
─────────────────────────────────────────────────────────
☐ ИТ стратегия согласована с бизнесом
☐ Система аудита функционирует
☐ Резервное копирование проводится
☐ Доступ контролируется
☐ Эффективная коммуникация обеспечена

IV. МОНИТОРИНГ
─────────────────────────────────────────────────────────
☐ Внутренний аудит проводится
☐ Результаты доводятся до руководства
☐ Отслеживание нарушений обеспечено
☐ Правильность отчетов проверяется

V. КЛЮЧЕВЫЕ БИЗНЕС-ПРОЦЕССЫ
─────────────────────────────────────────────────────────
ПРОЦЕСС | КОНТРОЛЬ | ЭФФЕКТИВНОСТЬ | РИСК
───────────────────────────────────────────────────
Продажи | ✓ Счета-фактуры | Адекватна | Низкий
Закупки | ✓ Заявки | Адекватна | Низкий
Зарплата | ✓ Табели | Хорошая | Низкий
Кассовые | ✓ Сверки | Хорошая | Средний
ОС | ✓ Реестр | Адекватна | Низкий

VI. ВЫЯВЛЕННЫЕ НЕДОСТАТКИ
─────────────────────────────────────────────────────────
☐ Существенные недостатки: НЕТ
☐ Значимые недостатки: _____________________
☐ Незначительные замечания: _____________________

VII. РЕКОМЕНДАЦИИ
─────────────────────────────────────────────────────────
1. _________________________________________________________________
2. _________________________________________________________________
3. _________________________________________________________________

ОБЩЕЕ ЗАКЛЮЧЕНИЕ
═══════════════════════════════════════════════════════════
Система внутреннего контроля в целом:
☐ Сильная ☐ Адекватная ☐ Слабая

Оценка: _____________________

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const subsequentEvents = `
═══════════════════════════════════════════════════════════
СОБЫТИЯ ПОСЛЕ ОТЧЕТНОЙ ДАТЫ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период аудита: ${new Date().getFullYear()} год
Дата завершения аудита: ${date}

I. ПРОЦЕДУРЫ ВЫЯВЛЕНИЯ СОБЫТИЙ
─────────────────────────────────────────────────────────
☐ Проверены протоколы совещаний руководства
☐ Получены письменные подтверждения руководства
☐ Получены конфирмации от банков и адвокатов
☐ Просмотрены документы до даты завершения аудита
☐ Получена информация о судебных разбирательствах

II. ВЫЯВЛЕННЫЕ СОБЫТИЯ
─────────────────────────────────────────────────────────
Дата события | Описание события | Влияние на ОФ | Необходимость корректировки
────────────────────────────────────────────────────────────────
___________ | _______________ | ____________ | __________________________

III. КЛАССИФИКАЦИЯ СОБЫТИЙ
─────────────────────────────────────────────────────────
Событие | Требует корректировки ОФ | Требует раскрытия | Действие
───────────────────────────────────────────────────────────────────
1. | Да / Нет | Да / Нет | _____
2. | Да / Нет | Да / Нет | _____
3. | Да / Нет | Да / Нет | _____

IV. ПРИМЕРЫ ЗНАЧИМЫХ СОБЫТИЙ
─────────────────────────────────────────────────────────
☐ Выпуск новых долговых инструментов
☐ Приобретение или продажа активов
☐ Банкротство дебитора
☐ Причинение убытка в результате стихийного бедствия
☐ Объявление о дивидендах
☐ Судебные решения
☐ Значительные изменения в условиях ведения бизнеса

V. ПИСЬМЕННЫЕ ПОДТВЕРЖДЕНИЯ РУКОВОДСТВА
─────────────────────────────────────────────────────────
Получено письменное подтверждение о:
☐ Информированности о требованиях МСА 560
☐ Раскрытии всех известных событий
☐ Отсутствии прочих значимых событий после отчетной даты

VI. АДВОКАТСКИЕ ПИСЬМА
─────────────────────────────────────────────────────────
Получены ли письма от адвокатов: Да / Нет
Судебные разбирательства выявлены: Да / Нет
Вероятные убытки: ___________________

VII. СОБЫТИЯ ПОСЛЕ ДАТЫ ЗАВЕРШЕНИЯ АУДИТА
─────────────────────────────────────────────────────────
(между датой завершения и датой подписания заключения)
Выявлены события: Да / Нет
Описание: _________________________________________________________________

ВЫВОД
═══════════════════════════════════════════════════════════
☐ События после отчетной даты адекватно раскрыты в ОФ
☐ События требуют корректировки ОФ
☐ События не оказывают влияния на ОФ

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const bankStatement = `
═══════════════════════════════════════════════════════════
ВЫПИСКА ИЗ БАНКА И СВЕРКА
═══════════════════════════════════════════════════════════
Организация: ${client.name}
На дату: 31.12.${new Date().getFullYear()}
Дата сверки: ${date}

I. БАНКОВСКИЕ СЧЕТА
─────────────────────────────────────────────────────────
№ счета | Валюта | Наименование банка | Остаток | Статус
──────────────────────────────────────────────────────────
1. | ТЕ | Bank | _____ | Активный
2. | USD | Bank | _____ | Активный
3. | EUR | Bank | _____ | Активный
──────────────────────────────────────────────────────────
ИТОГО: | | | _____ |

II. СВЕРКА ВЫПИСКИ С УЧЕТОМ
─────────────────────────────────────────────────────────
Остаток по выписке банка: ___________________
Остаток по учету компании: ___________________
Разница: ___________________

III. НЕВЫЯСНЕННЫЕ РАЗНИЦЫ
─────────────────────────────────────────────────────────
Невыясненные поступления: ___________________
Невыясненные платежи: ___________________
Прочие разницы: ___________________

IV. РАСЧЕТ СВЕРКИ
─────────────────────────────────────────────────────────
Остаток по выписке: ___________________
+ Невыясненные поступления: ___________________
- Невыясненные платежи: ___________________
─────────────────────────────────────────────────────────
= Сверенный остаток: ___________________

V. АНАЛИЗ КАССОВЫХ ПОТОКОВ
─────────────────────────────────────────────────────────
Поступления за период: ___________________
Платежи за период: ___________________
Приток / отток денежных средств: ___________________

VI. КОНЦЕНТРАЦИЯ СРЕДСТВ
─────────────────────────────────────────────────────────
Основной счет: _____ % средств
Второстепенные счета: _____ %
Резервные счета: _____ %

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const auditOpinion = `
═══════════════════════════════════════════════════════════
АУДИТОРСКОЕ ЗАКЛЮЧЕНИЕ
═══════════════════════════════════════════════════════════
НЕЗАВИСИМОМУ АУДИТОРСКОМУ ЗАКЛЮЧЕНИЮ

Лицам, отвечающим за корпоративное управление ТОО "${client.name}"

ОТ АУДИТОРСКОЙ ОРГАНИЗАЦИИ
═══════════════════════════════════════════════════════════
ТОО "FinExpertiza Kazakhstan"

МНЕНИЕ
═══════════════════════════════════════════════════════════
Я провел аудит финансовой отчетности ТОО "${client.name}" (далее - организация),
которая включает бухгалтерский баланс на 31 декабря ${new Date().getFullYear()} года и отчет
о финансовых результатах, отчет об изменениях капитала и отчет о движении
денежных средств за год, закончившийся указанной датой, и пояснения к ней.

На мое профессиональное суждение, финансовая отчетность достоверно представляет
финансовое положение организации на 31 декабря ${new Date().getFullYear()} года и результаты ее
деятельности за год, закончившийся указанной датой, в соответствии с Международными
стандартами финансовой отчетности.

ОСНОВАНИЕ ДЛЯ ВЫРАЖЕНИЯ МНЕНИЯ
═══════════════════════════════════════════════════════════
Я провел аудит в соответствии с Международными стандартами аудита (МСА).
Мои ответственность согласно этим стандартам описана в разделе "Ответственность
аудитора за аудит финансовой отчетности" моего заключения.

Я независим от организации в соответствии с требованиями профессиональной этики,
содержащимися в Кодексе профессиональной этики Международной федерации бухгалтеров,
применимыми для моего выполнения аудита финансовой отчетности. Я выполнил свои
иные профессиональные обязанности в соответствии с этими требованиями.

Я считаю, что полученные мной аудиторские доказательства являются достаточными
и надлежащими для обоснования моего мнения.

ОТВЕТСТВЕННОСТЬ РУКОВОДСТВА И ЛИЦ, ОТВЕЧАЮЩИХ ЗА КОРПОРАТИВНОЕ УПРАВЛЕНИЕ
═══════════════════════════════════════════════════════════
Руководство организации несет ответственность за подготовку финансовой отчетности
в соответствии с Международными стандартами финансовой отчетности, за надлежащее
ведение бухгалтерского учета и внутренний контроль, необходимый для подготовки
финансовой отчетности.

При подготовке финансовой отчетности руководство несет ответственность за оценку
способности организации продолжать непрерывно свою деятельность.

ОТВЕТСТВЕННОСТЬ АУДИТОРА ЗА АУДИТ ФИНАНСОВОЙ ОТЧЕТНОСТИ
═══════════════════════════════════════════════════════════
Цель моего аудита состояла в получении достаточной уверенности о том, не содержит ли
финансовая отчетность существенных искажений как по причине недобросовестных действий,
так и вследствие ошибок, и в выражении мнения о финансовой отчетности на основе
проведенного аудита.

Я выполнил аудиторские процедуры в целях получения аудиторских доказательств о:
• Наличии и правильности классификации операций;
• Полноте и правильности документирования и регистрации операций;
• Существовании активов и обязательств на дату баланса;
• Праве собственности на активы;
• Оценке активов и обязательств;
• Раскрытии информации.

Как результат процедур выявления рисков я оценил риски существенного искажения
финансовой отчетности. На основе этой оценки я разработал и выполнил аудиторские
процедуры, направленные на снижение аудиторского риска до приемлемо низкого уровня.

ЗАКЛЮЧЕНИЕ
═══════════════════════════════════════════════════════════
✓ ЗАКЛЮЧЕНИЕ БЕЗ ОГОВОРОК - ПОЛОЖИТЕЛЬНОЕ МНЕНИЕ

На основе проведенного аудита финансовая отчетность ТОО "${client.name}"
за ${new Date().getFullYear()} год достоверна и составлена в полном соответствии с применимым
законодательством и Международными стандартами финансовой отчетности.

_________________________________________________________________

Руководитель аудиторской организации: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const managementLetter = `
═══════════════════════════════════════════════════════════
ПИСЬМО С ВЫВОДАМИ ПО РЕЗУЛЬТАТАМ АУДИТА
═══════════════════════════════════════════════════════════
Генеральному директору и лицам, отвечающим за корпоративное управление
ТОО "${client.name}"
Дата: ${date}

ВВОДНАЯ ЧАСТЬ
═══════════════════════════════════════════════════════════
Как часть нашего аудита финансовой отчетности ТОО "${client.name}" за ${new Date().getFullYear()} год,
я наблюдал и тестировал операции и остатки счетов, которые вам были представлены.
Результаты аудита были в целом удовлетворительны. Настоящее письмо содержит
важные выводы, которые требуют вашего внимания.

ВЫЯВЛЕННЫЕ ВОПРОСЫ
═══════════════════════════════════════════════════════════
1. ЗНАЧИМЫЕ ВОПРОСЫ ПО КАЧЕСТВУ УЧЕТА
Обнаружено: _____________________
Рекомендация: _____________________

2. НЕДОСТАТКИ ВНУТРЕННЕГО КОНТРОЛЯ
Обнаружено: _____________________
Рекомендация: _____________________

3. ВОПРОСЫ ПО НАЛОГОВОМУ УЧЕТУ
Обнаружено: _____________________
Рекомендация: _____________________

ПОЛОЖИТЕЛЬНЫЕ АСПЕКТЫ
═══════════════════════════════════════════════════════════
✓ Система внутреннего контроля в целом функционирует адекватно
✓ Финансовая отчетность подготовлена в соответствии с МСФО
✓ Своевременность предоставления информации обеспечена
✓ Ведение бухгалтерского учета осуществляется надлежащим образом

РЕКОМЕНДАЦИИ
═══════════════════════════════════════════════════════════
1. Усилить контроль над процессом выверки счетов
2. Повысить квалификацию бухгалтерского персонала
3. Внедрить автоматизацию отдельных процессов учета
4. Провести переподготовку по МСФО

ЗАКЛЮЧЕНИЕ
═══════════════════════════════════════════════════════════
Финансовая отчетность достоверно отражает финансовое положение
организации и может быть использована для принятия решений.

С уважением,
ТОО "FinExpertiza Kazakhstan"
Аудитор: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const governanceLetter = `
═══════════════════════════════════════════════════════════
ПРИВЯЗКА К ЛИЦАМ, ОТВЕЧАЮЩИМ ЗА КОРПОРАТИВНОЕ УПРАВЛЕНИЕ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата: ${date}

I. ИДЕНТИФИКАЦИЯ ЛИЦ
─────────────────────────────────────────────────────────
Лица, отвечающие за корпоративное управление (ЛОКУ):

1. Генеральный директор: ${client.management?.director || '___________________'}
Назначен(а): _____________________
Полномочия: _____________________

2. Главный бухгалтер: ${client.management?.accountant || '___________________'}
Назначен(а): _____________________
Полномочия: _____________________

3. Прочие члены руководства: _____________________

II. ОТВЕТСТВЕННОСТЬ ЛОКУ
─────────────────────────────────────────────────────────
☐ Одобрение финансовой отчетности
☐ Одобрение аудита
☐ Назначение внутреннего аудитора
☐ Установление политик учета
☐ Управление внутренним контролем
☐ Утверждение стратегии развития

III. ОСНОВНЫЕ КОММУНИКАЦИИ
─────────────────────────────────────────────────────────
Дата последнего совещания: _____________________
Обсуждаемые вопросы: _____________________
Результаты: _____________________

IV. ПИСЬМЕННЫЕ ПОДТВЕРЖДЕНИЯ
─────────────────────────────────────────────────────────
☐ Письменное подтверждение полноты раскрытия получено
☐ Письменное подтверждение об отсутствии недобросовестности получено
☐ Письменное подтверждение о непрерывности получено

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const analyticalProcedures = `
═══════════════════════════════════════════════════════════
АНАЛИТИЧЕСКИЕ ПРОЦЕДУРЫ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата: ${date}

I. ПРЕДВАРИТЕЛЬНЫЕ АНАЛИТИЧЕСКИЕ ПРОЦЕДУРЫ
─────────────────────────────────────────────────────────
Показатель | ${new Date().getFullYear() - 1} г. | ${new Date().getFullYear()} г. | Изменение | % изменения | Примечание
────────────────────────────────────────────────────────────────
Доход | _____ | _____ | _____ | _____% | ________
Расходы | _____ | _____ | _____ | _____% | ________
Прибыль | _____ | _____ | _____ | _____% | ________
ОС | _____ | _____ | _____ | _____% | ________
Запасы | _____ | _____ | _____ | _____% | ________

II. АНАЛИЗ КОЭФФИЦИЕНТОВ
─────────────────────────────────────────────────────────
Коэффициент | ${new Date().getFullYear() - 1} г. | ${new Date().getFullYear()} г. | Отклонение | Оценка
───────────────────────────────────────────────────────────
Текущей ликвидности | _____ | _____ | _____ | ✓/✗
Быстрой ликвидности | _____ | _____ | _____ | ✓/✗
Рентабельность активов | _____ | _____ | _____ | ✓/✗
Рентабельность капитала | _____ | _____ | _____ | ✓/✗
Рентабельность продаж | _____ | _____ | _____ | ✓/✗

III. СТРУКТУРНЫЙ АНАЛИЗ (% К ДОХОДУ)
─────────────────────────────────────────────────────────
Себестоимость | _____ %
Операционные расходы | _____ %
Прибыль операционная | _____ %
Прибыль до налогов | _____ %

IV. ВЫЯВЛЕННЫЕ АНОМАЛИИ
─────────────────────────────────────────────────────────
Аномалия | Значимость | Объяснение | Тестирование
───────────────────────────────────────────────────────
1. | Высокая | _________ | Проведено ✓
2. | Средняя | _________ | Проведено ✓
3. | Низкая | _________ | Проведено ✓

V. ВЫВОДЫ
─────────────────────────────────────────────────────────
Результаты аналитических процедур:
☐ Соответствуют ожиданиям
☐ Имеют необычные отклонения
☐ Требуют дополнительного расследования

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    const goingConcern = `
═══════════════════════════════════════════════════════════
СВЕДЕНИЯ О НЕПРЕРЫВНОСТИ ДЕЯТЕЛЬНОСТИ
═══════════════════════════════════════════════════════════
Организация: ${client.name}
Период: ${new Date().getFullYear()} год
Дата: ${date}

I. ОЦЕНКА ПРЕДПОЛОЖЕНИЯ О НЕПРЕРЫВНОСТИ
─────────────────────────────────────────────────────────
☐ Предположение о непрерывности обоснованно
☐ Выявлены события, вызывающие сомнения
☐ Управление принял меры для смягчения рисков

II. ФАКТОРЫ, ПОДДЕРЖИВАЮЩИЕ НЕПРЕРЫВНОСТЬ
─────────────────────────────────────────────────────────
☐ Прибыльная деятельность
☐ Достаточный уровень ликвидности
☐ Наличие кредитных линий
☐ Стабильный спрос на продукцию
☐ Хорошие отношения с кредиторами

III. ФАКТОРЫ РИСКА, ВЫЗЫВАЮЩИЕ СОМНЕНИЯ
─────────────────────────────────────────────────────────
☐ Текущие убытки
☐ Отрицательный денежный поток
☐ Нарушение кредитных ковенантов
☐ Уход ключевых персонала
☐ Потеря основного клиента
☐ Судебные разбирательства
☐ Изменения в законодательстве

Выявленные риски: _____________________

IV. АНАЛИЗ ДЕНЕЖНЫХ ПОТОКОВ
─────────────────────────────────────────────────────────
Денежный поток от деятельности: ___________________
Денежный поток от инвестиций: ___________________
Денежный поток от финансирования: ___________________
Остаток денежных средств на конец года: ___________________
Достаточность для 12 месяцев: Да / Нет

V. ПЛАНЫ УПРАВЛЕНИЯ ПО СМЯГЧЕНИЮ РИСКОВ
─────────────────────────────────────────────────────────
1. _________________________________________________________________
2. _________________________________________________________________
3. _________________________________________________________________

VI. ПИСЬМЕННЫЕ ПОДТВЕРЖДЕНИЯ
─────────────────────────────────────────────────────────
☐ Руководство подтвердило отсутствие намерения ликвидировать организацию
☐ Руководство подтвердило наличие планов по улучшению ситуации
☐ Руководство предоставило информацию обо всех известных рисках

VII. ВЫВОДЫ
─────────────────────────────────────────────────────────
На основе проведенной оценки:
☐ Предположение о непрерывности обоснованно
☐ Имеются существенные сомнения относительно непрерывности
☐ Требуется раскрытие информации в примечаниях

Раскрытие информации в отчетности: Да / Нет

Подготовил: _____________________ (подпись)
Дата: ${date}
    `.trim();

    return {
      kycForm,
      independenceForm,
      complianceChecklist,
      eqrForm: eqrForm || '',
      clientAcceptanceForm,
      itSecurityChecklist,
      engagementLetter,
      teamIndependenceStatements,
      organizationIndependenceStatement,
      communicationProtocol,
      auditPlan,
      workingPapers,
      riskMatrix,
      taxDeclaration,
      payrollStatement,
      fixedAssets,
      inventory,
      financialObligations,
      relatedParties,
      internalControl,
      subsequentEvents,
      bankStatement,
      auditOpinion,
      managementLetter,
      governanceLetter,
      analyticalProcedures,
      goingConcern
    };
  };

  const loadDemoClients = () => {
    const demoClientsWithDocs: MSUKClient[] = DEMO_CLIENTS.map(client => ({
      id: Date.now() + Math.random(),
      ...client,
      documents: generateDocuments(client)
    }));
    setClients([...clients, ...demoClientsWithDocs]);
    setShowDemo(false);
    toast({
      title: "Примеры загружены",
      description: `Добавлено ${demoClientsWithDocs.length} примеров клиентов.`,
    });
  };

  const handleFileUpload = async (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0];
    if (!file) return;

    if (!file.name.match(/\.(txt|docx?)$/i)) {
      toast({
        title: "Ошибка",
        description: "Поддерживаются только файлы .txt и .docx",
        variant: "destructive"
      });
      return;
    }

    setIsParsing(true);
    try {
      const parsed = await parseDocument(file);
      
      // Обновляем formData с распарсенными данными
      setFormData(prev => ({
        ...prev,
        ...parsed,
        management: parsed.management || prev.management,
        teamMembers: parsed.teamMembers || prev.teamMembers
      }));
      
      toast({
        title: "Документ распарсен",
        description: "Данные из документа загружены. Проверьте и дополните информацию.",
      });
      setShowUploadDialog(false);
    } catch (error) {
      toast({
        title: "Ошибка парсинга",
        description: "Не удалось распарсить документ. Попробуйте другой файл.",
        variant: "destructive"
      });
    } finally {
      setIsParsing(false);
    }
  };

  const handleAddClient = useCallback(() => {
    const validation = validateClientData({ name: formData.name, inn: formData.inn });
    
    if (!validation.isValid) {
      toast({
        title: "Ошибка валидации",
        description: validation.error || "Проверьте введенные данные",
        variant: "destructive"
      });
      return;
    }

    const newClient: MSUKClient = {
      id: Date.now(),
      name: sanitizeString(formData.name),
      inn: formData.inn.trim(),
      country: formData.country,
      industry: formData.industry,
      address: formData.address,
      publicCompany: formData.publicCompany,
      litigation: formData.litigation,
      conflictOfInterest: formData.conflictOfInterest,
      employees: formData.employees,
      employeesInAccounting: formData.employeesInAccounting,
      revenue: formData.revenue,
      documentFlow: formData.documentFlow,
      management: formData.management,
      teamMembers: formData.teamMembers,
      documents: generateDocuments(formData)
    };

    setClients([...clients, newClient]);
    setFormData({
      name: '',
      inn: '',
      country: 'RU',
      industry: '',
      address: '',
      publicCompany: false,
      litigation: false,
      conflictOfInterest: false,
      employees: '',
      employeesInAccounting: '',
      revenue: '',
      documentFlow: '',
      management: {
        director: '',
        directorPosition: '',
        directorContact: '',
        accountant: '',
        accountantContact: ''
      },
      teamMembers: []
    });
    setShowForm(false);
    
    toast({
      title: "Клиент добавлен",
      description: `Клиент "${newClient.name}" успешно добавлен.`,
    });
  }, [formData, clients, toast]);

  const handleDeleteClient = (id: number) => {
    const client = clients.find(c => c.id === id);
    setClients(clients.filter(c => c.id !== id));
    if (currentClient?.id === id) {
      setCurrentClient(null);
    }
    toast({
      title: "Клиент удален",
      description: `Клиент "${client?.name}" удален.`,
      variant: "destructive"
    });
  };

  const viewDocument = (content: string, title: string) => {
    setPreviewData(content);
    setPreviewTitle(title);
    setShowPreview(true);
  };

  const downloadDocument = (content: string, filename: string) => {
    const element = document.createElement('a');
    const file = new Blob([content], {type: 'text/plain;charset=utf-8'});
    element.href = URL.createObjectURL(file);
    element.download = filename;
    document.body.appendChild(element);
    element.click();
    document.body.removeChild(element);
    URL.revokeObjectURL(element.href);
    
    toast({
      title: "Документ скачан",
      description: `Файл "${filename}" успешно скачан.`,
    });
  };

  return (
    <div className="space-y-6 animate-fade-in p-4 md:p-0">
      {/* Заголовок */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold bg-gradient-to-r from-primary to-warning bg-clip-text text-transparent flex items-center gap-3">
            <BookOpen className="w-8 h-8 text-primary" />
            МСУК-1 Manager Pro
          </h1>
          <p className="text-muted-foreground mt-1">Аудиторская комплаенс-система</p>
        </div>
        <Badge className="text-lg px-4 py-2">
          {clients.length} клиентов
        </Badge>
      </div>

      {/* Быстрый старт */}
      {clients.length === 0 && (
        <Card className="bg-gradient-to-r from-blue-500 to-purple-600 text-white border-0">
          <div className="p-6">
            <div className="flex items-center justify-between flex-col sm:flex-row gap-4">
              <div>
                <h2 className="text-xl font-bold mb-2 flex items-center gap-2">
                  <Zap className="w-6 h-6" />
                  Быстрый старт
                </h2>
                <p className="text-blue-100">Загрузите 6 примеров клиентов с разными уровнями рисков</p>
              </div>
              <Button
                onClick={() => setShowDemo(true)}
                className="bg-white text-blue-600 hover:bg-blue-50 whitespace-nowrap"
              >
                <Zap className="w-4 h-4 mr-2" />
                Загрузить примеры
              </Button>
            </div>
          </div>
        </Card>
      )}

      {/* Основной контент - двухколоночный layout */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Левая панель - список клиентов */}
        <div className="lg:col-span-1">
          <Card className="overflow-hidden">
            <div className="bg-primary text-primary-foreground p-4 flex items-center justify-between">
              <h2 className="font-semibold">Клиенты ({clients.length})</h2>
              <Button
                onClick={() => setShowForm(true)}
                variant="secondary"
                size="icon"
                className="h-8 w-8"
              >
                <Plus className="w-4 h-4" />
              </Button>
            </div>

            <div className="divide-y max-h-[600px] overflow-y-auto">
              {clients.length === 0 ? (
                <div className="p-6 text-center text-muted-foreground">
                  <FileText className="w-12 h-12 mx-auto mb-2 opacity-50" />
                  <p>Нет клиентов</p>
                </div>
              ) : (
                clients.map(client => {
                  const risk = calculateRisk(client);
                  return (
                    <div
                      key={client.id}
                      onClick={() => setCurrentClient(client)}
                      className={`p-4 cursor-pointer transition ${
                        currentClient?.id === client.id ? 'bg-primary/10 border-l-4 border-primary' : 'hover:bg-secondary/50'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1 min-w-0">
                          <h3 className="font-semibold text-sm truncate">{client.name}</h3>
                          <p className="text-xs text-muted-foreground">{client.inn}</p>
                          <div className="mt-2 flex gap-1 flex-wrap">
                            <Badge
                              variant={
                                risk.riskText === 'ВЫСОКИЙ' ? 'destructive' :
                                risk.riskText === 'СРЕДНИЙ' ? 'default' : 'secondary'
                              }
                              className="text-xs"
                            >
                              {risk.riskText}
                            </Badge>
                            {risk.eqrRequired && (
                              <Badge variant="outline" className="text-xs bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-200">
                                EQR
                              </Badge>
                            )}
                          </div>
                        </div>
                        <Button
                          onClick={(e) => {
                            e.stopPropagation();
                            handleDeleteClient(client.id);
                          }}
                          variant="ghost"
                          size="icon"
                          className="h-6 w-6 text-destructive hover:text-destructive"
                        >
                          <Trash2 className="w-4 h-4" />
                        </Button>
                      </div>
                    </div>
                  );
                })
              )}
            </div>
          </Card>
        </div>

        {/* Правая панель - детали клиента или форма */}
        <div className="lg:col-span-2">
          {showForm ? (
            <Card className="p-6">
              <h2 className="text-xl font-bold mb-4">Добавить клиента</h2>
              <div className="space-y-4">
                <div>
                  <Label htmlFor="name">Название компании *</Label>
                  <Input
                    id="name"
                    placeholder="ТОО 'Компания'"
                    value={formData.name}
                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                  />
                </div>

                <div>
                  <Label htmlFor="inn">ИНН *</Label>
                  <Input
                    id="inn"
                    placeholder="7700000000"
                    value={formData.inn}
                    onChange={(e) => setFormData({...formData, inn: e.target.value})}
                  />
                </div>

                <div>
                  <Label htmlFor="country">Страна</Label>
                  <Select
                    value={formData.country}
                    onValueChange={(value: 'RU' | 'KZ') => setFormData({...formData, country: value})}
                  >
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="RU">Россия</SelectItem>
                      <SelectItem value="KZ">Казахстан</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label htmlFor="industry">Вид деятельности</Label>
                  <Input
                    id="industry"
                    placeholder="Энергетика, Финансовые услуги, и т.д."
                    value={formData.industry}
                    onChange={(e) => setFormData({...formData, industry: e.target.value})}
                  />
                </div>

                <div>
                  <Label htmlFor="employees">Количество сотрудников</Label>
                  <Input
                    id="employees"
                    placeholder="1000"
                    value={formData.employees}
                    onChange={(e) => setFormData({...formData, employees: e.target.value})}
                  />
                </div>

                <div>
                  <Label htmlFor="revenue">Годовой доход (млн тенге)</Label>
                  <Input
                    id="revenue"
                    placeholder="10000"
                    value={formData.revenue}
                    onChange={(e) => setFormData({...formData, revenue: e.target.value})}
                  />
                </div>

                <div className="space-y-3 pt-4 border-t">
                  <div className="flex items-center space-x-2">
                    <Checkbox
                      id="publicCompany"
                      checked={formData.publicCompany}
                      onCheckedChange={(checked) => setFormData({...formData, publicCompany: checked as boolean})}
                    />
                    <Label htmlFor="publicCompany" className="cursor-pointer">
                      Публичная компания (ПЗО)
                    </Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Checkbox
                      id="litigation"
                      checked={formData.litigation}
                      onCheckedChange={(checked) => setFormData({...formData, litigation: checked as boolean})}
                    />
                    <Label htmlFor="litigation" className="cursor-pointer">
                      Судебные разбирательства
                    </Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Checkbox
                      id="conflictOfInterest"
                      checked={formData.conflictOfInterest}
                      onCheckedChange={(checked) => setFormData({...formData, conflictOfInterest: checked as boolean})}
                    />
                    <Label htmlFor="conflictOfInterest" className="cursor-pointer">
                      Конфликт интересов
                    </Label>
                  </div>
                </div>

                <div className="flex gap-2 pt-4 border-t">
                  <Button 
                    onClick={() => setShowUploadDialog(true)} 
                    variant="outline" 
                    className="flex-1"
                    type="button"
                  >
                    <Upload className="w-4 h-4 mr-2" />
                    Загрузить документ
                  </Button>
                </div>

                <div className="flex gap-2 pt-4">
                  <Button onClick={handleAddClient} className="flex-1">
                    <CheckCircle className="w-4 h-4 mr-2" />
                    Добавить
                  </Button>
                  <Button onClick={() => setShowForm(false)} variant="outline" className="flex-1">
                    Отмена
                  </Button>
                </div>
              </div>
            </Card>
          ) : currentClient && currentRisk ? (
            <div className="space-y-4">
              {/* Информация о клиенте */}
              <Card className="p-6">
                <h2 className="text-2xl font-bold mb-4">{sanitizeString(currentClient.name)}</h2>
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <Label className="text-xs text-muted-foreground">ИНН</Label>
                    <p className="font-semibold">{currentClient.inn}</p>
                  </div>
                  <div>
                    <Label className="text-xs text-muted-foreground">Страна</Label>
                    <p className="font-semibold">{currentClient.country}</p>
                  </div>
                  <div>
                    <Label className="text-xs text-muted-foreground">Сотрудников</Label>
                    <p className="font-semibold">{currentClient.employees}</p>
                  </div>
                  <div>
                    <Label className="text-xs text-muted-foreground">Доход (млн)</Label>
                    <p className="font-semibold">{currentClient.revenue}</p>
                  </div>
                </div>
                {currentRisk.factors.length > 0 && (
                  <div className="p-4 bg-destructive/10 rounded-lg border border-destructive/20">
                    <h3 className="font-semibold text-destructive mb-2 flex items-center gap-2">
                      <AlertCircle className="w-4 h-4" />
                      Факторы риска
                    </h3>
                    <ul className="space-y-1">
                      {currentRisk.factors.map((f, i) => (
                        <li key={i} className="text-sm text-destructive/80">{f}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </Card>

              {/* Документы */}
              <Card className="p-6">
                <h3 className="text-lg font-bold mb-4 flex items-center gap-2">
                  <FileText className="w-5 h-5" />
                  Документы ({Object.keys(currentClient.documents).length})
                </h3>
                <div className="space-y-2 max-h-[600px] overflow-y-auto">
                  {/* Список всех документов */}
                  {Object.entries(currentClient.documents).map(([key, content]) => {
                    if (!content) return null;
                    
                    const docTitles: { [key: string]: string } = {
                      kycForm: '📋 Анкета клиента',
                      independenceForm: '✓ Заявление о независимости',
                      complianceChecklist: '☐ Чеклист МСУК-1',
                      eqrForm: '🔴 Назначение EQR',
                      clientAcceptanceForm: '📝 Анкета принятия клиента',
                      itSecurityChecklist: '🔒 ИТ Безопасность',
                      engagementLetter: '📄 Письмо-соглашение (МСА 210)',
                      teamIndependenceStatements: '👥 Заявления членов команды',
                      organizationIndependenceStatement: '🏢 Заявление организации',
                      communicationProtocol: '📞 Протокол общения',
                      auditPlan: '📊 План проведения аудита',
                      workingPapers: '📑 Рабочие бумаги аудитора',
                      riskMatrix: '⚖️ Матрица рисков аудита',
                      taxDeclaration: '💰 Налоговая декларация',
                      payrollStatement: '💼 Трудовые отношения и зарплата',
                      fixedAssets: '🏗️ Основные средства',
                      inventory: '📦 Запасы и ТМЦ',
                      financialObligations: '💳 Финансовые обязательства',
                      relatedParties: '🔗 Связанные стороны',
                      internalControl: '🛡️ Внутренний контроль',
                      subsequentEvents: '📅 События после отчетной даты',
                      bankStatement: '🏦 Выписка из банка',
                      auditOpinion: '✅ Аудиторское заключение',
                      managementLetter: '📨 Письмо с выводами',
                      governanceLetter: '👔 Привязка к ЛОКУ',
                      analyticalProcedures: '📈 Аналитические процедуры',
                      goingConcern: '🔄 Непрерывность деятельности'
                    };
                    
                    const docStyles: { [key: string]: { bg: string; border: string; text: string; btn: string; btnHover: string } } = {
                      kycForm: { bg: 'bg-blue-50 dark:bg-blue-900/20', border: 'border-blue-200 dark:border-blue-800', text: 'text-blue-900 dark:text-blue-100', btn: 'bg-blue-500 hover:bg-blue-600 border-blue-500', btnHover: 'bg-blue-600 hover:bg-blue-700' },
                      independenceForm: { bg: 'bg-green-50 dark:bg-green-900/20', border: 'border-green-200 dark:border-green-800', text: 'text-green-900 dark:text-green-100', btn: 'bg-green-500 hover:bg-green-600 border-green-500', btnHover: 'bg-green-600 hover:bg-green-700' },
                      complianceChecklist: { bg: 'bg-purple-50 dark:bg-purple-900/20', border: 'border-purple-200 dark:border-purple-800', text: 'text-purple-900 dark:text-purple-100', btn: 'bg-purple-500 hover:bg-purple-600 border-purple-500', btnHover: 'bg-purple-600 hover:bg-purple-700' },
                      eqrForm: { bg: 'bg-red-50 dark:bg-red-900/20', border: 'border-red-200 dark:border-red-800', text: 'text-red-900 dark:text-red-100', btn: 'bg-red-500 hover:bg-red-600 border-red-500', btnHover: 'bg-red-600 hover:bg-red-700' },
                      clientAcceptanceForm: { bg: 'bg-orange-50 dark:bg-orange-900/20', border: 'border-orange-200 dark:border-orange-800', text: 'text-orange-900 dark:text-orange-100', btn: 'bg-orange-500 hover:bg-orange-600 border-orange-500', btnHover: 'bg-orange-600 hover:bg-orange-700' },
                      itSecurityChecklist: { bg: 'bg-cyan-50 dark:bg-cyan-900/20', border: 'border-cyan-200 dark:border-cyan-800', text: 'text-cyan-900 dark:text-cyan-100', btn: 'bg-cyan-500 hover:bg-cyan-600 border-cyan-500', btnHover: 'bg-cyan-600 hover:bg-cyan-700' },
                      engagementLetter: { bg: 'bg-indigo-50 dark:bg-indigo-900/20', border: 'border-indigo-200 dark:border-indigo-800', text: 'text-indigo-900 dark:text-indigo-100', btn: 'bg-indigo-500 hover:bg-indigo-600 border-indigo-500', btnHover: 'bg-indigo-600 hover:bg-indigo-700' },
                      teamIndependenceStatements: { bg: 'bg-pink-50 dark:bg-pink-900/20', border: 'border-pink-200 dark:border-pink-800', text: 'text-pink-900 dark:text-pink-100', btn: 'bg-pink-500 hover:bg-pink-600 border-pink-500', btnHover: 'bg-pink-600 hover:bg-pink-700' },
                      organizationIndependenceStatement: { bg: 'bg-teal-50 dark:bg-teal-900/20', border: 'border-teal-200 dark:border-teal-800', text: 'text-teal-900 dark:text-teal-100', btn: 'bg-teal-500 hover:bg-teal-600 border-teal-500', btnHover: 'bg-teal-600 hover:bg-teal-700' },
                      communicationProtocol: { bg: 'bg-amber-50 dark:bg-amber-900/20', border: 'border-amber-200 dark:border-amber-800', text: 'text-amber-900 dark:text-amber-100', btn: 'bg-amber-500 hover:bg-amber-600 border-amber-500', btnHover: 'bg-amber-600 hover:bg-amber-700' },
                      auditPlan: { bg: 'bg-violet-50 dark:bg-violet-900/20', border: 'border-violet-200 dark:border-violet-800', text: 'text-violet-900 dark:text-violet-100', btn: 'bg-violet-500 hover:bg-violet-600 border-violet-500', btnHover: 'bg-violet-600 hover:bg-violet-700' },
                      workingPapers: { bg: 'bg-slate-50 dark:bg-slate-900/20', border: 'border-slate-200 dark:border-slate-800', text: 'text-slate-900 dark:text-slate-100', btn: 'bg-slate-500 hover:bg-slate-600 border-slate-500', btnHover: 'bg-slate-600 hover:bg-slate-700' },
                      riskMatrix: { bg: 'bg-rose-50 dark:bg-rose-900/20', border: 'border-rose-200 dark:border-rose-800', text: 'text-rose-900 dark:text-rose-100', btn: 'bg-rose-500 hover:bg-rose-600 border-rose-500', btnHover: 'bg-rose-600 hover:bg-rose-700' },
                      taxDeclaration: { bg: 'bg-emerald-50 dark:bg-emerald-900/20', border: 'border-emerald-200 dark:border-emerald-800', text: 'text-emerald-900 dark:text-emerald-100', btn: 'bg-emerald-500 hover:bg-emerald-600 border-emerald-500', btnHover: 'bg-emerald-600 hover:bg-emerald-700' },
                      payrollStatement: { bg: 'bg-lime-50 dark:bg-lime-900/20', border: 'border-lime-200 dark:border-lime-800', text: 'text-lime-900 dark:text-lime-100', btn: 'bg-lime-500 hover:bg-lime-600 border-lime-500', btnHover: 'bg-lime-600 hover:bg-lime-700' },
                      fixedAssets: { bg: 'bg-stone-50 dark:bg-stone-900/20', border: 'border-stone-200 dark:border-stone-800', text: 'text-stone-900 dark:text-stone-100', btn: 'bg-stone-500 hover:bg-stone-600 border-stone-500', btnHover: 'bg-stone-600 hover:bg-stone-700' },
                      inventory: { bg: 'bg-fuchsia-50 dark:bg-fuchsia-900/20', border: 'border-fuchsia-200 dark:border-fuchsia-800', text: 'text-fuchsia-900 dark:text-fuchsia-100', btn: 'bg-fuchsia-500 hover:bg-fuchsia-600 border-fuchsia-500', btnHover: 'bg-fuchsia-600 hover:bg-fuchsia-700' },
                      financialObligations: { bg: 'bg-sky-50 dark:bg-sky-900/20', border: 'border-sky-200 dark:border-sky-800', text: 'text-sky-900 dark:text-sky-100', btn: 'bg-sky-500 hover:bg-sky-600 border-sky-500', btnHover: 'bg-sky-600 hover:bg-sky-700' },
                      relatedParties: { bg: 'bg-yellow-50 dark:bg-yellow-900/20', border: 'border-yellow-200 dark:border-yellow-800', text: 'text-yellow-900 dark:text-yellow-100', btn: 'bg-yellow-500 hover:bg-yellow-600 border-yellow-500', btnHover: 'bg-yellow-600 hover:bg-yellow-700' },
                      internalControl: { bg: 'bg-zinc-50 dark:bg-zinc-900/20', border: 'border-zinc-200 dark:border-zinc-800', text: 'text-zinc-900 dark:text-zinc-100', btn: 'bg-zinc-500 hover:bg-zinc-600 border-zinc-500', btnHover: 'bg-zinc-600 hover:bg-zinc-700' },
                      subsequentEvents: { bg: 'bg-neutral-50 dark:bg-neutral-900/20', border: 'border-neutral-200 dark:border-neutral-800', text: 'text-neutral-900 dark:text-neutral-100', btn: 'bg-neutral-500 hover:bg-neutral-600 border-neutral-500', btnHover: 'bg-neutral-600 hover:bg-neutral-700' },
                      bankStatement: { bg: 'bg-blue-50 dark:bg-blue-900/20', border: 'border-blue-200 dark:border-blue-800', text: 'text-blue-900 dark:text-blue-100', btn: 'bg-blue-500 hover:bg-blue-600 border-blue-500', btnHover: 'bg-blue-600 hover:bg-blue-700' },
                      auditOpinion: { bg: 'bg-green-50 dark:bg-green-900/20', border: 'border-green-200 dark:border-green-800', text: 'text-green-900 dark:text-green-100', btn: 'bg-green-500 hover:bg-green-600 border-green-500', btnHover: 'bg-green-600 hover:bg-green-700' },
                      managementLetter: { bg: 'bg-orange-50 dark:bg-orange-900/20', border: 'border-orange-200 dark:border-orange-800', text: 'text-orange-900 dark:text-orange-100', btn: 'bg-orange-500 hover:bg-orange-600 border-orange-500', btnHover: 'bg-orange-600 hover:bg-orange-700' },
                      governanceLetter: { bg: 'bg-purple-50 dark:bg-purple-900/20', border: 'border-purple-200 dark:border-purple-800', text: 'text-purple-900 dark:text-purple-100', btn: 'bg-purple-500 hover:bg-purple-600 border-purple-500', btnHover: 'bg-purple-600 hover:bg-purple-700' },
                      analyticalProcedures: { bg: 'bg-indigo-50 dark:bg-indigo-900/20', border: 'border-indigo-200 dark:border-indigo-800', text: 'text-indigo-900 dark:text-indigo-100', btn: 'bg-indigo-500 hover:bg-indigo-600 border-indigo-500', btnHover: 'bg-indigo-600 hover:bg-indigo-700' },
                      goingConcern: { bg: 'bg-teal-50 dark:bg-teal-900/20', border: 'border-teal-200 dark:border-teal-800', text: 'text-teal-900 dark:text-teal-100', btn: 'bg-teal-500 hover:bg-teal-600 border-teal-500', btnHover: 'bg-teal-600 hover:bg-teal-700' }
                    };
                    
                    const styles = docStyles[key] || { bg: 'bg-gray-50 dark:bg-gray-900/20', border: 'border-gray-200 dark:border-gray-800', text: 'text-gray-900 dark:text-gray-100', btn: 'bg-gray-500 hover:bg-gray-600 border-gray-500', btnHover: 'bg-gray-600 hover:bg-gray-700' };
                    const title = docTitles[key] || key;
                    
                    return (
                      <div key={key} className={`${styles.bg} rounded-lg p-3 border ${styles.border}`}>
                        <span className={`font-semibold ${styles.text}`}>{title}</span>
                        <div className="flex gap-2 mt-2">
                          <Button
                            onClick={() => viewDocument(content, title)}
                            variant="outline"
                            className={`flex-1 text-white ${styles.btn}`}
                          >
                            <Eye className="w-4 h-4 mr-2" />
                            Просмотр
                          </Button>
                          <Button
                            onClick={() => downloadDocument(content, `${title.replace(/[^\w\s]/g, '')}_${currentClient.name.replace(/\s/g, '_')}.txt`)}
                            className={`flex-1 text-white ${styles.btnHover}`}
                          >
                            <Download className="w-4 h-4 mr-2" />
                            Скачать
                          </Button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </Card>

              {/* Статус риска */}
              <Card className={`p-6 ${
                currentRisk.riskText === 'ВЫСОКИЙ' ? 'bg-destructive/10 border-2 border-destructive' :
                currentRisk.riskText === 'СРЕДНИЙ' ? 'bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-300 dark:border-yellow-700' :
                'bg-green-50 dark:bg-green-900/20 border-2 border-green-300 dark:border-green-700'
              }`}>
                <h3 className="font-bold mb-2 flex items-center gap-2">
                  {currentRisk.riskText === 'ВЫСОКИЙ' ? (
                    <AlertCircle className="w-5 h-5 text-destructive" />
                  ) : (
                    <CheckCircle className="w-5 h-5 text-green-600" />
                  )}
                  <span className={
                    currentRisk.riskText === 'ВЫСОКИЙ' ? 'text-destructive' :
                    currentRisk.riskText === 'СРЕДНИЙ' ? 'text-yellow-700 dark:text-yellow-300' :
                    'text-green-700 dark:text-green-300'
                  }>
                    СТАТУС: {
                      currentRisk.riskText === 'ВЫСОКИЙ' ? 'ВЫСОКИЙ РИСК ⚠️' :
                      currentRisk.riskText === 'СРЕДНИЙ' ? 'СРЕДНИЙ РИСК 🟡' :
                      'НИЗКИЙ РИСК ✅'
                    }
                  </span>
                </h3>
                <p className={
                  currentRisk.riskText === 'ВЫСОКИЙ' ? 'text-destructive' :
                  currentRisk.riskText === 'СРЕДНИЙ' ? 'text-yellow-600 dark:text-yellow-400' :
                  'text-green-600 dark:text-green-400'
                }>
                  {currentRisk.riskText === 'ВЫСОКИЙ' ? '⚠️ Требуется усиленная проверка и EQR' :
                   currentRisk.riskText === 'СРЕДНИЙ' ? '🟡 Повышенное внимание к процедурам' :
                   '✅ Стандартные процедуры достаточны'}
                </p>
              </Card>
            </div>
          ) : (
            <Card className="p-12 text-center">
              <FileText className="w-16 h-16 mx-auto text-muted-foreground mb-4" />
              <p className="text-muted-foreground text-lg">Выберите клиента</p>
            </Card>
          )}
        </div>
      </div>

      {/* Диалог примеров */}
      <Dialog open={showDemo} onOpenChange={setShowDemo}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>⚡ Примеры клиентов</DialogTitle>
            <DialogDescription>
              Выберите примеры или загрузите все 6 клиентов с разными уровнями рисков
            </DialogDescription>
          </DialogHeader>

          <div className="p-6 space-y-3 max-h-96 overflow-y-auto">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {DEMO_CLIENTS.map((client, i) => {
                const risk = calculateRisk(client);
                return (
                  <Card
                    key={i}
                    className={`p-4 border-2 ${
                      risk.riskText === 'ВЫСОКИЙ' ? 'bg-destructive/10 border-destructive' :
                      risk.riskText === 'СРЕДНИЙ' ? 'bg-yellow-50 dark:bg-yellow-900/20 border-yellow-300 dark:border-yellow-700' :
                      'bg-green-50 dark:bg-green-900/20 border-green-300 dark:border-green-700'
                    }`}
                  >
                    <h4 className="font-semibold text-sm mb-1">{client.name}</h4>
                    <p className="text-xs text-muted-foreground mb-2">{client.industry}</p>
                    <div className="flex items-center justify-between">
                      <Badge
                        variant={
                          risk.riskText === 'ВЫСОКИЙ' ? 'destructive' :
                          risk.riskText === 'СРЕДНИЙ' ? 'default' : 'secondary'
                        }
                        className="text-xs"
                      >
                        {risk.riskText}
                      </Badge>
                      {risk.eqrRequired && (
                        <Badge variant="outline" className="text-xs text-destructive">
                          EQR ⚠️
                        </Badge>
                      )}
                    </div>
                  </Card>
                );
              })}
            </div>

            <Button
              onClick={loadDemoClients}
              className="w-full mt-6"
            >
              <CheckCircle className="w-4 h-4 mr-2" />
              Загрузить все 6 примеров
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Диалог загрузки файла */}
      <Dialog open={showUploadDialog} onOpenChange={setShowUploadDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Загрузить документ для парсинга</DialogTitle>
            <DialogDescription>
              Загрузите файл .txt или .docx с информацией о клиенте. Система автоматически извлечет данные.
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div className="border-2 border-dashed border-primary rounded-lg p-6 text-center">
              <Upload className="w-12 h-12 mx-auto mb-4 text-muted-foreground" />
              <Label htmlFor="file-upload" className="cursor-pointer">
                <span className="text-primary font-semibold">Выберите файл</span>
                <input
                  id="file-upload"
                  type="file"
                  accept=".txt,.docx,.doc"
                  onChange={handleFileUpload}
                  className="hidden"
                  disabled={isParsing}
                />
              </Label>
              <p className="text-sm text-muted-foreground mt-2">
                Поддерживаются файлы .txt и .docx
              </p>
            </div>
            {isParsing && (
              <div className="text-center text-muted-foreground">
                Парсинг документа...
              </div>
            )}
          </div>
        </DialogContent>
      </Dialog>

      {/* Диалог предпросмотра документа */}
      <Dialog open={showPreview} onOpenChange={setShowPreview}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
          <DialogHeader>
            <DialogTitle>{previewTitle}</DialogTitle>
          </DialogHeader>

          <div className="flex-1 overflow-y-auto p-6 bg-secondary rounded-md">
            <pre className="font-mono text-xs whitespace-pre-wrap break-words">
              {previewData}
            </pre>
          </div>

          <div className="flex gap-3 pt-4 border-t">
            <Button
              onClick={() => setShowPreview(false)}
              variant="outline"
              className="flex-1"
            >
              Закрыть
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}
